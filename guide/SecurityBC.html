<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Security Bounded Context Implementation | Business Operations Framework Documentation</title>
    <meta name="description" content="">
    
    <meta name="description" content="Business Operations Framework Documentation">
    <meta name="theme-color" content="#00a3ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="preload" href="/business-operations-framework-docs/assets/css/0.styles.3c4fa570.css" as="style"><link rel="preload" href="/business-operations-framework-docs/assets/js/app.7bcea79d.js" as="script"><link rel="preload" href="/business-operations-framework-docs/assets/js/2.b8067fb5.js" as="script"><link rel="preload" href="/business-operations-framework-docs/assets/js/13.961d9ff5.js" as="script"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/10.a871e841.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/11.f3bc5132.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/12.0c6f6b4a.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/14.0b838c92.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/3.a870cfac.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/4.b6b71d3a.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/5.86d4a69e.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/6.05495cc9.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/7.bb433bc0.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/8.f2d0ec90.js"><link rel="prefetch" href="/business-operations-framework-docs/assets/js/9.9cb862e6.js">
    <link rel="stylesheet" href="/business-operations-framework-docs/assets/css/0.styles.3c4fa570.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="main-docs-wrapper"><div class="main-content-wrapper"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/business-operations-framework-docs/" class="home-link router-link-active"><img src="/business-operations-framework-docs/mojaloop_logo_med.png" alt="Business Operations Framework Documentation" class="logo"> <span class="site-name can-hide">Business Operations Framework Documentation</span></a> <!----> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technical Guide" class="dropdown-title"><span class="title">Technical Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/Guide/" class="nav-link">
  Technical Introduction
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/Guide/SecurityBC.html" class="nav-link">
  Security BC Implementation
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/Guide/Microfrontend-JAMStack.html" class="nav-link">
  Micro-frontend - JAMStack design
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/Guide/ReportingBC.html" class="nav-link">
  Reporting BC Implementation
  <!----></a></li></ul></div></div><div class="nav-item"><a href="https://mojaloop.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mojaloop
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://docs.mojaloop.io/mojaloop-business-docs/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Business Documents
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div> <!----></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technical Guide" class="dropdown-title"><span class="title">Technical Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/Guide/" class="nav-link">
  Technical Introduction
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/Guide/SecurityBC.html" class="nav-link">
  Security BC Implementation
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/Guide/Microfrontend-JAMStack.html" class="nav-link">
  Micro-frontend - JAMStack design
  <!----></a></li><li class="dropdown-item"><!----> <a href="/business-operations-framework-docs/Guide/ReportingBC.html" class="nav-link">
  Reporting BC Implementation
  <!----></a></li></ul></div></div><div class="nav-item"><a href="https://mojaloop.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Mojaloop
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://docs.mojaloop.io/mojaloop-business-docs/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Business Documents
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Technical Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/business-operations-framework-docs/guide/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/business-operations-framework-docs/guide/SecurityBC.html" aria-current="page" class="active sidebar-link">Security Bounded Context Implementation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#introduction-to-the-security-bc" class="active sidebar-link">Introduction to the security BC</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#tools-standards-chosen" class="sidebar-link">Tools / standards chosen</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#overview-architecture" class="sidebar-link">Overview Architecture</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#alignment-to-the-reference-architecture" class="sidebar-link">Alignment to the Reference Architecture</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#alignment-with-iac-4-xxx" class="sidebar-link">Alignment with IaC 4.xxx</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#logging-into-the-ui-sequence-diagrams" class="sidebar-link">Logging into the UI - sequence diagrams</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#bc-operational-api-micro-frontend-querying-data" class="sidebar-link">BC Operational API micro-frontend - querying data</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#assigning-roles-participant-access-to-users" class="sidebar-link">Assigning Roles &amp; Participant access to Users</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#assigning-permissions-to-roles" class="sidebar-link">Assigning Permissions to Roles</a></li><li class="sidebar-sub-header"><a href="/business-operations-framework-docs/guide/SecurityBC.html#ory-keto-implemention-detail" class="sidebar-link">Ory Keto - implemention detail</a></li></ul></li><li><a href="/business-operations-framework-docs/guide/Microfrontend-JAMStack.html" class="sidebar-link">Micro-frontend - JAMStack design</a></li><li><a href="/business-operations-framework-docs/guide/ReportingBC.html" class="sidebar-link">Reporting Bounded Context Implementation</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="content content__default"><h1 id="security-bounded-context-implementation"><a href="#security-bounded-context-implementation" class="header-anchor">#</a> Security Bounded Context Implementation</h1> <h2 id="introduction-to-the-security-bc"><a href="#introduction-to-the-security-bc" class="header-anchor">#</a> Introduction to the security BC</h2> <p>The security bounded context refers to the <a href="https://ref-arch-docs.moja-lab.live/refarch/boundedContexts/security/" target="_blank" rel="noopener noreferrer">bounded security domain<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> as defined in the reference architecture documentation.<br>
To meet the security objectives of this framework, part of the reference architecture security bounded context has been implmented. This guide outlines the high level designs and explains the design thinging that went into the design.</p> <p>The security design:</p> <ol><li>implements role based access control to the current Mojaloop version</li> <li>is compatible with the reference architecture and therefore future versions of Mojaloop</li> <li>is compatible with future IaC deployments</li> <li>provides activity logging that can be used in an audit.</li></ol> <h2 id="tools-standards-chosen"><a href="#tools-standards-chosen" class="header-anchor">#</a> Tools / standards chosen</h2> <p>Here is a list of standard tools that have been chosen to implement in this design.</p> <ol><li><strong>Ory Oathkeeper</strong><br>
Will be used as the Identity and Access Proxy (IAP) that will check authentication and authorization before providing access to functional end points. I.e. it will be used to enforce the access control.</li> <li><strong>Ory Keto</strong><br>
Will check authorization via subject-role and role-permission mappings. It uses a flexible object, relationship and subject structure pioneered at Google that can model many authorization schemes, including RBAC.</li> <li><strong>Ory Kratos</strong><br>
Will use Ory Kratos to create and manage the cookie authorization object.</li> <li><strong>OpenID Connect</strong><br>
Is the standard that has been chosen to interact with an identity management system. This is a widely supported standard, and is compatible with all the tools currently in use in the Mojaloop community. I.e. WS02 IS, Keycloak and Ory Kratos</li></ol> <h2 id="overview-architecture"><a href="#overview-architecture" class="header-anchor">#</a> Overview Architecture</h2> <p>Here is a high level architecture overview of the implementation of this security bounded context onto the current Mojaloop version.</p> <p><img src="/BizOps-Framework-IaC-3.xx-&amp;-Mojaloop-13.xx.png" alt="Architecture Overview Diagram of Security Bounded Context Implementation"></p> <p>Here is a table of the services and the roles they are playing.</p> <table><thead><tr><th>Service</th> <th>Owns</th> <th>Implements</th></tr></thead> <tbody><tr><td><strong>WS02 IS KM</strong></td> <td>users</td> <td>1. user login redirection and UI that creates the cookie token <br>2. standard OIDC authorization code flow</td></tr> <tr><td><strong>Ory Keto</strong></td> <td>1. The roles mapped to users <br> 2. The participant mapped to users</td> <td>1. API RBAC Authorisation check through Oathkeeper<br>2. API ABAC Authorisation check through Operational API call</td></tr> <tr><td><strong>Ory Oathkeeper</strong></td> <td>The permissions related to API access</td> <td>API Gateway for operational APIs with authentication and authorization checks</td></tr> <tr><td><strong>Ory Kratos</strong></td> <td>nothing</td> <td>Authentication Cookie</td></tr> <tr><td><strong>BC Operational API</strong></td> <td>The permissions related to the operational API calls</td> <td>Operational API functions</td></tr> <tr><td><strong>Shim</strong></td> <td>nothing</td> <td>Redirect to configure OIDC</td></tr> <tr><td><strong>Operator Role</strong></td> <td>nothing</td> <td>update Keto to reflect role-permission assignment changes made in the role-resource file</td></tr> <tr><td><strong>Kubernetes role-resource file</strong></td> <td>The roles and the role-permission assignments</td> <td>Edits of this file are controlled through a version control implementaiton. (e.g. Github or GitLab)</td></tr> <tr><td><strong>User Role API</strong></td> <td>nothing</td> <td>1. Role-user API controls <br>(list of users, list of roles, list of roles assigned to users, add role to user, remove role from user.)<br> 2. participant-user API controls <br>(list of users, list of participants, list of participants assigned to user, add participant to user, remove participant from user.)</td></tr></tbody></table> <h2 id="alignment-to-the-reference-architecture"><a href="#alignment-to-the-reference-architecture" class="header-anchor">#</a> Alignment to the Reference Architecture</h2> <p>This overview diagram illustrated how this design conforms with the reference architecture. Some fuctions have been implemented, and others haven’t been implemented, see the details below.</p> <p><img src="/BizOps-Framework-Security-BC.png" alt="Overview Diagram illustrating the alignment to the Reference Architecture"></p> <h3 id="functions-implemented"><a href="#functions-implemented" class="header-anchor">#</a> Functions Implemented</h3> <p>This implmentation of the security BC takes advantage of standard security tools available. In the case where a reference architecture function is alrealy implemented by the chosen standard tool, then it was decided to use that tools function. Where that was done, a mention to the appropriate tool is made.</p> <ol><li><p><strong>Create Users / Apps / Groups</strong><br>
The create of users, groups and application identity accounts should be done directly in the chosen Identity and Key Management solution being used. In the IaC 3.xx version deployment of Mojaloop, this is the WS02 IS KM module.</p></li> <li><p><strong>Login</strong><br>
A cookie based authentication token has been implemented, and this funcitonallity is performed by both Ory Kratos (who manages the cookie) and the Identity &amp; Key Management system (who create the authentication token).</p></li> <li><p><strong>Assign Users / Apps / Groups to Roles</strong><br>
The assignment of user, group and app identity accounts to roles is performed by the backend Role-Api, (who make the relevent changes to Keto).</p></li> <li><p><strong>Create Roles &amp; Assign Privileges to Roles</strong><br>
The assignment of permissions or privileges to roles is performed by change the roleresource.yml files. A version control system e.g. github, is the control mechanism for changes made to this file. Change to the file are uploaded to keto via the kubernetes role operator.</p></li></ol> <h3 id="functions-not-implemented"><a href="#functions-not-implemented" class="header-anchor">#</a> Functions not Implemented</h3> <ol><li><p><strong>Communicate Permissions/Privileges</strong> by each BC on startup.<br>
This is not implemented</p></li> <li><p><strong>BC Login</strong><br>
This refers to the logging in of each bounded context as they startup. Current no bounded context have implemented this functionallity, so this requirement has not been implemented either.</p></li> <li><p><strong>BC setup callback</strong><br>
There is no requirement for this if each BC doesn’t login. This has not been implemented.</p></li></ol> <h3 id="additional-functionallity-added"><a href="#additional-functionallity-added" class="header-anchor">#</a> Additional functionallity added</h3> <ol><li><p><strong>BC verify claim</strong><br>
By this we are refering to the ability of a Bounded Context that is implementing an Operational API to be able to query if the provided token has authorisation to a defined permission or privilege.<br>
This was not a requirement specified by the reference architecture, however it was a requirement to fulfill the generic reporting BC API. This functionallity has been made available and is implemented using a standard Keto API.</p></li> <li><p><strong>Assignment of Participant access</strong><br>
In order to implementent external API’s to participant DFSPs, an aditional permission assignment was added where participant access is added to identity accounts. This has been implemented in Keto and maintained through the User-Role API. Checking access is through a standard Keto API call.</p></li></ol> <h2 id="alignment-with-iac-4-xxx"><a href="#alignment-with-iac-4-xxx" class="header-anchor">#</a> Alignment with IaC 4.xxx</h2> <p>Here is a diagram illustrating how the high level architecture would look like if this security bounded context implementation design was implemented on the next IaC version (IaC 4.xxx version) that uses Keycloak and Ambassador / Envoy amongst other changes.</p> <p><img src="/BizOps-Framework-IaC-4.xx-&amp;-Mojaloop-13.xx.png" alt="Architecture Overview Diagram of Security Bounded Context Implementation"></p> <h2 id="logging-into-the-ui-sequence-diagrams"><a href="#logging-into-the-ui-sequence-diagrams" class="header-anchor">#</a> Logging into the UI - sequence diagrams</h2> <p>This sequence diagram illustrates the sequence of events that occur when a brower attemps to access a backend API.</p> <ul><li>If the browser is already logged in, then the request is forwarded.</li> <li>If the brower isn’t logged in then a standard Open Id Connect (OIDC) authorization flow is triggered starting with a redirect.</li></ul> <p><img src="/frontend.png" alt="Sequence diagram illustrating how a brower logs in"></p> <h2 id="bc-operational-api-micro-frontend-querying-data"><a href="#bc-operational-api-micro-frontend-querying-data" class="header-anchor">#</a> BC Operational API micro-frontend - querying data</h2> <p>Sequence diagram shows more details regarding interactions if</p> <ul><li>the bearer token is valid or invalid</li> <li>or whether authorisation passes or fails.<br>
The Micro-frontend is represented as a client.</li></ul> <p><img src="/client.png" alt="Sequence diagram illustrating how an API client call has its authorisation performed"></p> <p>If a more detailed authorisation check is required to be performed by the operational API, then this sequence diagrams describes how that is implemented.<br>
It is important to note that not all operational API will require this level of authorisation, and that the Oathkeeper control may or may not be required in this use case.</p> <p><img src="/clientgraphql.png" alt="Sequence diagram illustrating how an API client call has its authorisation performed"></p> <h2 id="assigning-roles-participant-access-to-users"><a href="#assigning-roles-participant-access-to-users" class="header-anchor">#</a> Assigning Roles &amp; Participant access to Users</h2> <p>This functionallity is implemented in the User Role API Service. These sequence diagrams describes how the User Role and User Participation access is queried and modified by this API.<br> <img src="/userroles.png" alt="Sequence diagram illustrating how roles and participant access is assigned to users"></p> <h3 id="user-role-api"><a href="#user-role-api" class="header-anchor">#</a> User - Role API</h3> <p>These are the user-role API resources.</p> <table><thead><tr><th>Category</th> <th>HTTP Method</th> <th>End point</th> <th>Description</th> <th>Error Codes</th></tr></thead> <tbody><tr><td><strong>HEALTH</strong></td> <td></td> <td></td> <td></td> <td></td></tr> <tr><td></td> <td>GET</td> <td>/health</td> <td>used to return the current status of the API</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td></td> <td>GET</td> <td>/metrics</td> <td>used to return metrics for the API</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td><strong>PARTICIPANTS</strong></td> <td></td> <td></td> <td></td> <td></td></tr> <tr><td></td> <td>GET</td> <td>/participants</td> <td>used to return a list of participant ids</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td><strong>ROLES</strong></td> <td></td> <td></td> <td></td> <td></td></tr> <tr><td></td> <td>GET</td> <td>/roles</td> <td>used to return a list of role ids</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td><strong>USERS</strong></td> <td></td> <td></td> <td></td> <td></td></tr> <tr><td></td> <td>GET</td> <td>/users</td> <td>used to return a list of user ids</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td></td> <td>GET</td> <td>/users/{ID}</td> <td>used to return a specifc user</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td></td> <td>GET</td> <td>/users/{ID}/participants</td> <td>return a list of participants assigned to a user</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td></td> <td>PATCH</td> <td>/users/{ID}/participants</td> <td>used to assign a participant to a user</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td></td> <td>GET</td> <td>/users/{ID}/roles</td> <td>return a list of roles assigned to a user</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr> <tr><td></td> <td>PATCH</td> <td>/users/{ID}/roles</td> <td>used to assign a role to a user</td> <td>400, 401, 403, 404, 405, 406, 501, 503</td></tr></tbody></table> <p>The detailed specification of the Roles API can be found <a href="https://docs.mojaloop.io/role-assignment-service/" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.<br>
The git repository can be found <a href="https://github.com/mojaloop/role-assignment-service" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="assigning-permissions-to-roles"><a href="#assigning-permissions-to-roles" class="header-anchor">#</a> Assigning Permissions to Roles</h2> <p>The permission to role assignment is store in a yml file that we are calling a Role Resource file.<br>
Access and changes to these files with be managed through a hosted version control like github, or gitlab. This is convienent as this keeps a full history and has configurable automatic and manual control points.<br>
These Role Resource files are mapped as Kubernetes CRD’s against which a role permission operator subscribes to. Changes to the role resource files trigger the Role Permission Operator to update Ory Keto with the corresponding appropriate change. A role can be represented by more than one file if necessary.</p> <p>Here is an example of a role resource file:</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;mojaloop.io/v1&quot;</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> MojaloopRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> arbitrary<span class="token punctuation">-</span>name<span class="token punctuation">-</span>here
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># must match what it is used in Keto, whatever that is</span>
  <span class="token key atrule">role</span><span class="token punctuation">:</span> RoleIdentifier
  <span class="token key atrule">permissions</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> permission_01
  <span class="token punctuation">-</span> permission_02
  <span class="token punctuation">-</span> permission_03
  <span class="token punctuation">-</span> permission_04'
</code></pre></div><p>This sequence digram illustrates how Ort Keto is updated.</p> <p><img src="/rolepermissions.png" alt="Sequence diagram illustrating how roles and participant access is assigned to users"><br>
Example of resource YML file roleresource.yaml</p> <h2 id="ory-keto-implemention-detail"><a href="#ory-keto-implemention-detail" class="header-anchor">#</a> Ory Keto - implemention detail</h2> <p>Ory Keto in this design is the tool that implements the logic of whether a login token has the correct authorisation to access an aspect of the system. I.e. it is use to enforce the RBAC (Role Based Access  Control). There are three part to how this is implemented in Keto:</p> <ol><li>The assignment of roles to users.<br>
This functionallity will be maintained and updated from the Role-User API module; which will call and update Keto accordingly.</li> <li>The assignment of participant access to a user.<br>
This refers to the DFSP access reports that must only provide reports for the configured participants.<br>
This functionallity will also be maintained via the Role-User API module; which will call and update Keto accordingly.</li> <li>The assignment of permissions or privileges to roles. This will be controled through the edits of a github roleresource.yml file. The kubernetes role-permission operator is the service that will monitor these roleresource files, and update Keto to affect the assignments.</li></ol> <h3 id="adding-roles-and-participant-access-to-users-in-keto"><a href="#adding-roles-and-participant-access-to-users-in-keto" class="header-anchor">#</a> Adding roles and participant access to users in Keto</h3> <p>The user list (which includes both people and service accounts) will be retrieved from WSO2 Identity Server, and the participant list from the existing API for that purpose. In both cases, a durable permanent identifier should be what is then used as part of the Keto calls.</p> <p>The list of roles will be hardcoded, and every role should be given a unique short identifier that is human readable and writeable as well as a name. The UI should display both the identifier and the name, since the identifier will be needed for use in the role-permission operator.</p> <p>There will be two Keto namespaces used for calls, role and participant. The Keto tuples used will be</p> <div class="language- extra-class"><pre class="language-text"><code>role:ROLEID#member@USERID and participant:PARTICIPANTID#member@USERID 
</code></pre></div><p>(using the notation used for <a href="https://www.ory.sh/keto/docs/concepts/relation-tuples" target="_blank" rel="noopener noreferrer">Keto/Zanzibar<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. )</p> <p>The reuse of the relation “member” is not an issue, each relation is namespace-specific. If there’s a preferred terminology for the participant-user relationship other than member, that word can be used instead, and should be documented here.</p> <p>To retrieve the role or participant list for a particular user, the <a href="https://www.ory.sh/keto/docs/reference/rest-api#query-relation-tuples" target="_blank" rel="noopener noreferrer">Query Relation Tuples API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> will be used , and the namespace, relation, and subject provided as parameters. This will provide a list of tuples in the response, with a next page token if there are additional results, and the identifiers for the participants or roles can be read from the resulting tuples.</p> <p>When a role or participant is added or removed for a user, the <a href="https://www.ory.sh/keto/docs/reference/rest-api#create-a-relation-tuple" target="_blank" rel="noopener noreferrer">create<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://www.ory.sh/keto/docs/reference/rest-api#delete-a-relation-tuple" target="_blank" rel="noopener noreferrer">delete<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> relation tuple calls can be used, since only a single tuple is involved at a time. If the call fails, but the failure isn’t 4xx, it should be retried a couple times.</p> <p>Here is an example of the Keto API call used to add roles to users.</p> <div class="custom-block tip"><p class="custom-block-title">Example: Assign role to user in Ory Keto</p> <p>PATCH /relation-tuples HTTP/1.1<br>
Content-Type: application/json<br>
Accept: application/json</p></div> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;insert&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;relation_tuple&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;namespace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;role&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;object&quot;</span><span class="token operator">:</span> <span class="token string">&quot;RoleIdentifier&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;relation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;member&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;subject&quot;</span><span class="token operator">:</span> <span class="token string">&quot;userIdentifier&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>On success a 204 message is returned with no content</p> <ul><li>we are using “member” as our relation in our current implementation</li> <li>we use PATCH instead of PUT since PATCH works as a bulk create and/or delete</li></ul> <h3 id="adding-permissions-or-privileges-to-roles-in-keto"><a href="#adding-permissions-or-privileges-to-roles-in-keto" class="header-anchor">#</a> Adding permissions or privileges to roles in Keto</h3> <p>This will be a Kubernetes Operator for a Custom Resource Definition <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/_print/" target="_blank" rel="noopener noreferrer">(CRD)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The operator could be implemented in most any language; existing Modusbox Operator expertise is mostly based around <code>kopf</code>, a python framework, but there are options in Go and Node as well (and others).</p> <p>The operator should maintain a memory of all resources it manages, grouped by role. <a href="https://kopf.readthedocs.io/en/latest/indexing/" target="_blank" rel="noopener noreferrer">Kopf’s indexing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> functionality is ideal for this:</p> <p>When a role resource is changed, the list of permissions for that role across all role resources should be compiled, and a change sent through the Keto Patch <a href="https://www.ory.sh/keto/docs/reference/rest-api#patch-multiple-relation-tuples" target="_blank" rel="noopener noreferrer">Multiple Relation Tuples API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> using the patch actions <code>insert</code> and <code>delete</code>. It is necessary to take all role resources into account, because there may be multiple resources for one role, and more than one may include the same permission, so deleting a role resource that maps Role X to Permission P does not necessarily mean that the Keto tuple for that role-permission connection needs to be deleted, since there may still be another role resource mapping Role X to Permission P.</p> <p>The Keto tuples will be of the form:</p> <div class="language- extra-class"><pre class="language-text"><code>permission:PERMISSIONID#granted@role:ROLEID#member
</code></pre></div><p>The specific operations on resource change are as follows:</p> <ol><li>Retrieve current permissions granted for role using the <a href="https://www.ory.sh/keto/docs/reference/rest-api/#query-relation-tuples" target="_blank" rel="noopener noreferrer">Query Relation Tuples API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Based on stored index of roles to permissions, compute a diff from the retrieved list.</li> <li>Execute patch from diff.</li> <li>If there are problems, throw an exception so the problem will log and a re-sync will be attempted later.</li></ol> <p>Here is an example of the Keto API call used to add permissions to roles.</p> <div class="custom-block tip"><p class="custom-block-title">Example: Assign permission/privilege to a role in Ory Keto</p> <p>PATCH /relation-tuples HTTP/1.1<br>
Content-Type: application/json<br>
Accept: application/json</p></div> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
  <span class="token property">&quot;action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;insert&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;relation_tuple&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;namespace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;permission&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;object&quot;</span><span class="token operator">:</span> <span class="token string">&quot;permissionIdentifier&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;relation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;granted&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;subject&quot;</span><span class="token operator">:</span> <span class="token string">&quot;role:x#member&quot;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>On success a 204 message is returned with no content</p> <ul><li>we are using “granted” as our relation in our current implementation</li> <li>we use PATCH instead of PUT since PATCH works as a bulk create and/or delete</li></ul> <h3 id="how-to-call-the-standard-keto-api-to-check-authorization"><a href="#how-to-call-the-standard-keto-api-to-check-authorization" class="header-anchor">#</a> How to call the standard Keto API to check authorization?</h3> <p>Checking to see if a user has authorisation for a priveledge or permission is managed by th API gateway, and if necessary can be checked by each bounded context.</p> <p>Here is an example of the Keto API call used to check for a users authorisation based on a permission/privilege.</p> <div class="custom-block tip"><p class="custom-block-title">Example: Checking for authorisation in Ory Keto</p> <p>POST /check HTTP/1.1<br>
Content-Type: application/json<br>
Accept: application/json</p></div> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;namespace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;permission&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;object&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PermissionIdentifier&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;relation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;granted&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;subject&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UserIdentifier&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Response:</strong></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
<span class="token property">&quot;allowed&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>/<span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/business-operations-framework-docs/guide/" class="prev router-link-active">
        Introduction
      </a></span> <span class="next"><a href="/business-operations-framework-docs/guide/Microfrontend-JAMStack.html">
        Micro-frontend - JAMStack design
      </a>
      →
    </span></p></div> </main> <!----></div></div> <!----></div><div class="global-ui"><!----></div></div>
    
    <script src="/business-operations-framework-docs/assets/js/app.7bcea79d.js" defer></script><script src="/business-operations-framework-docs/assets/js/2.b8067fb5.js" defer></script><script src="/business-operations-framework-docs/assets/js/13.961d9ff5.js" defer></script>
  </body>
</html>
